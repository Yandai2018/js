<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Use correct character set. -->
    <meta charset="utf-8">
    <!-- Tell IE to use the latest, best version. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>Hello World!</title>
    <script src="cesium/Cesium.js"></script>
    <script src="cesium/Sandcastle-header.js"></script>
    <script src="cesium/jquery-2.1.4.min.js"></script>
    <script src="cesium/jquery-form.js"></script>
    <style>
        @import url(cesium/bucket.css);

        #toolbar {
            background: rgba(42, 42, 42, 0.8);
            padding: 4px;
            border-radius: 4px;
        }

        button {
            color: #fff;
            background-color: #666666;
            text-align: center;
            border: 1px solid #1E90FF;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar" style="display:block;">
    <div align="center">
        按 F9 隐 藏 菜 单
    </div>
    <div>
        <div style="float:left;width:100%;">
            <div id="CreateCase" style="float: left">
            </div>
            <div style="float: left">
                <input type="file" id="case_file" style="display:none">
                <form id="kinetic_files" method="post" enctype="multipart/form-data" style="display:none"
                      action="/uploads" target="nm_iframe">
                    <input type="file" id="files" onchange="formSubmit()" name="upload" webkitdirectory mozdirectory>
                    <input type="submit" id="upload_confirm" value="确认上传文件夹">
                </form>

                <form action="/upload" , enctype="multipart/form-data" method="post" style="display:none">
                    <input type="file" name="upload" multiple="multipart">
                    <input type="submit" value="确认上传文件">
                </form>
                <iframe id="id_iframe" name="nm_iframe" style="display:none;"></iframe>
                <!--<input type="file" id="kinetic_file" webkitdirectory directory style="display:none" onchange="get_kinetic_file(this.value)">-->
                <table>
                    <tr>
                        <td>案 件 id：</td>
                        <td><select id="case_id" style="width:120px;height:25px" onchange="get_scenes(this.value)">
                            <option value="volvo" hidden>请选择案件</option>
                        </select></td>
                    </tr>
                </table>
            </div>
        </div>
        <div style="width:100%">
            <div id="CreateScene" style="float: left">
            </div>
            <div style="float: left">
                <table>
                    <tr>
                        <td>场 景 id：</td>
                        <td><select id="scene_id" style="width:120px;height:25px"
                                    onchange="show_operations(this.value)">
                            <option value="" hidden>请选择场景</option>
                        </select></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div id="operations" style="float: left;display:none">
        <div id="caseMenu" style="float: left"></div>
        <div id="modelMenu"></div>
        <div id="DynRoute"></div>
        <div>
            <div id="KineticMenu" style="float: left"></div>
            <div style="float: left;">
                <table>
                    <tr>
                        <td><select id="kinetic_model" style="width:120px;height:25px">
                            <option value="volvo" hidden>选择动力学模型</option>
                        </select></td>
                        <td><select id="models" style="width:120px;height:25px" onchange="locate_model(this.value)">
                            <option value="volvo" hidden>选择待标定模型</option>
                        </select></td>
                    </tr>

                </table>
            </div>
        </div>
        <div style="float: left">
            <div id="markMenu" style="float: left"></div>
            <div style="float: left">
                <table>
                    <tr>
                        <td><select id="element_type" style="width:120px;height:25px" onchange="get_element_menu(this.value)" value="scene_handprint">
                            <option value="volvo" hidden>选择要素类别</option>
                            <option value="scene_handprint" >手印痕迹</option>
                            <option value="scene_footprint" >足迹痕迹</option>
                            <option value="scene_toolmark" >工具痕迹</option>
                            <option value="scene_bio_evidence" >生物物证</option>
                            <option value="scene_file_evidence" >文检物证</option>
                            <option value="scene_elec_evidence" >电子物证</option>
                        </select></td>
                        <td><select  id="elements" style="width:120px;height:25px" onclick="get_element_menu(this.value)">
                            <option value="volvo" hidden>选择绑定要素</option>
                        </select></td>
                    </tr>

                </table>
            </div>
        </div>
        <div>
            <table>
                <tr>
                    <td>
                        <select id="top_icon_menu" style="width:100px;height:25px" onchange="get_sub_menu(this.value)">
                            <option value="volvo" hidden>选择图标大类</option>
                            <option value="办公类">办公类</option>
                            <option value="电子类">电子类</option>
                            <option value="交通类">交通类</option>
                            <option value="器具类">器具类</option>
                            <option value="生活类">生活类</option>
                            <option value="植物类">植物类</option>
                            <option value="主体类">主体类</option>
                            <option value="装饰类">装饰类</option>
                        </select>
                    </td>
                    <td><select id="sub_icon_menu" style="width:100px;height:25px" onchange="get_icon_menu(this.value)">
                        <option value="volvo" hidden>选择图标子类</option>
                    </select></td>
                    <td><select id="icon_menu" style="width:100px;height:25px" onchange="get_icon_image(this.value)">
                        <option value="volvo" hidden>选择图标图片</option>
                    </select></td>
                </tr>

            </table>
        </div>
    </div>
</div>

<script>

    $(document).ready(function () {
        var options = {
            target: '#output2',   // target element(s) to be updated with server response
            beforeSubmit:
                function (data) {
                    console.log("提交前函数");
                },
            success:
                function showResponse(responseText, statusText, xhr, $form) {
                    console.log(responseText);
                    alert(responseText.msg);
                    var gltfs = responseText.model_info;
                    for (var i = 0; i < gltfs.length; i += 2) {
                        $("#models").append('<option value=' + gltfs[i + 1] + ' >' + gltfs[i] + '</option>');
                    }
                    var kin = responseText.kinetic_id;

                    $("#kinetic_model").append('<option value=' + kin + ' >' + kin + '</option>');
                    $("#kinetic_model").val(kin);
                    // if(responseText.status == "0"){
                    //     console.log("上传成功");
                    //     /**
                    //      * 请求成功后的操作
                    //      */
                    //     alert(responseText);
                    // } else {
                    //     alert('上传失败');
                    // }
                },
            // other available options:
            //url:       url         // override for form's 'action' attribute
            //type:      type        // 'get' or 'post', override for form's 'method' attribute
            dataType: 'json'        // 'xml', 'script', or 'json' (expected server response type)
            //clearForm: true        // clear all form fields after successful submit
            //resetForm: true        // reset the form after successful submit

            // $.ajax options can be used here too, for example:
            //timeout:   3000
        };

        // bind to the form's submit event
        $('#kinetic_files').submit(function () {
            // inside event callbacks 'this' is the DOM element so we first
            // wrap it in a jQuery object and then invoke ajaxSubmit
            $(this).ajaxSubmit(options);

            // !!! Important !!!
            // always return false to prevent standard browser submit and page navigation
            return false;
        });
    });

    function formSubmit() {
        document.getElementById("upload_confirm").click();
    }

    $(function () {
        $("#files").on("change", function (e) {
            $.each(this.files, function (k, v) {
                console.log(v.type + "=" + v.webkitRelativePath);
            });
        });
    })
    // function select_case() {
    //     window
    //         .open(
    //             "create_case.html",
    //             "select_case",
    //             "height=700, width=1000, top=200, left=300,toolbar=no, menubar=no, scrollbars=no, resizable=no, location=no, status=no");
    // }
    // function get_kinetic_file(file_path){
    //     console.log(file_path);
    //     console.log("获得文件路径");
    // }
    function select_case() {
        $("#case_file").trigger("click");
    }

    //快捷键函数
    function keyDown(e) {
        ie = (document.all) ? true : false;
        if (ie) {
            //IE浏览器
            if (event.keyCode == 120) {//F2
                event.keyCode = 0;
                event.returnValue = false;
                console.log("按F9");
                var box = document.getElementById("toolbar");
                if (box.style.display != "block") {
                    box.style.display = "block";
                } else {
                    box.style.display = "none";
                }
            }
        } else {
            //非IE浏览器
            if (e.which == 120) {//F2
                e.which = 0;
                e.returnValue = false;
                //注意：此句不能少，否则火狐下个别热键会被重复调用；
                //如F5键：会先调用自定义函数，再刷新页面，其他同理
                console.log("按F9");
                var box = document.getElementById("toolbar");
                if (box.style.display != "block") {
                    box.style.display = "block";
                } else {
                    box.style.display = "none";
                }
            }
            // return false;
        }

    }

    document.onkeydown = keyDown;


    var viewer = new Cesium.Viewer('cesiumContainer', {
        shouldAnimate: true,
        baseLayerPicker: false,
        homeButton: false,       //是否显示home键
        timeline: true,        //是否显示时间线控件
        fullscreenButton: false, //是否全屏显示
        scene3DOnly: true,     //如果设置为true，则所有几何图形以3D模式绘制以节约GPU资源
        infoBox: true,         //是否显示点击要素之后显示的信息
        sceneModePicker: false,  //是否显示投影方式控件  三维/二维
        navigationInstructionsInitiallyVisible: false,
        navigationHelpButton: false,     //是否显示帮助信息控件
        selectionIndicator: false,        //是否显示指示器组件
        // imageryProvider : new Cesium.ArcGisMapServerImageryProvider({
        //     url : 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer'
        // }),
        // imageryProvider: new Cesium.createTileMapServiceImageryProvider({
        //     url: 'cesium/googleTMS',
        // }),
        terrainProvider: Cesium.createWorldTerrain()//加载地势
    });
    // var tdtImagerLayerProvider = new Cesium.WebMapTileServiceImageryProvider({
    //     url:"http://t0.tianditu.com/img_w/wmts?service=wmts&request=GetTile&version=1.0.0&LAYER=img&tileMatrixSet=w&TileMatrix={TileMatrix}&TileRow={TileRow}&TileCol={TileCol}&style=default&format=tiles",
    //     layer:"tiandituImg",
    //     style:"default",
    //     format:"image/jpeg",
    //     tileMatrixSetID:"tiandituImg",
    //     show:true,
    //     maximumLevel:18
    // });
    // viewer.imageryLayers.addImageryProvider(tdtImagerLayerProvider);
    viewer._cesiumWidget._creditContainer.style.display = "none";  //	去除版权信息
    viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(105.07224017290507, 36.56475804850547, 4889916.564370803),
        orientation: {
            heading: 0.0,
            pitch: Cesium.Math.toRadians(-90.0),
            roll: 0.0
        }
    });
    109.81099066476405, 40.81076609336931
    var scene = viewer.scene;
    var clock = viewer.clock;
    var czml = [{
        "id": "document",
        "name": "CZML_Model",
        "version": "1.0",
        "clock": {
            "interval": "2018-07-19T15:18:00Z/2018-07-19T15:19:00Z",
            "currentTime": "2018-07-19T15:18:00Z",
            "multiplier": 10,
            "range": "LOOP_STOP",
            "step": "SYSTEM_CLOCK_MULTIPLIER"
        }
    }, {
        "id": "GroundVehicle_model1",
        "name": "Cesium GroundVehicle",
        "position": {
            "cartographicDegrees": [
                // "2018-07-19T15:18:00Z", -78.01, 37, 10,
                // "2018-07-19T15:18:40Z", -78.0052, 37, 10,
                // "2018-07-19T15:19:00Z", -78.00519, 37, 10
                "2018-07-19T15:18:00Z", -78.00242281641076, 36.999381296457656, 70,
                "2018-07-19T15:18:30Z", -78.00216425320538, 36.999504833228826, 70,
                "2018-07-19T15:18:40Z", -78.00190620712641, 36.99962812292646, 70,
                "2018-07-19T15:19:00Z", -78.00190569, 36.99962837, 70
            ]
            // "interpolationAlgorithm": "LINEAR",
            // "forwardExtrapolationType": "HOLD",
            // "cartesian": [
            //     "2018-07-19T15:18:00Z", 1060146.830612113, -4988635.971350105, 3817341.934846987,
            //     "2018-07-19T15:18:40Z", 1060188.2574699132, -4988610.365637205, 3817363.7449174877,
            //     "2018-07-19T15:19:00Z", 1060188.4255027345, -4988610.261834476, 3817363.833305958
            //     // "2018-07-19T15:18:00Z",
            //     // 1060147.49466802, -4988639.096137246, 3817344.3420725837,
            //     // "2018-07-19T15:19:00Z",
            //     // 1060188.2574699132, -4988610.365637205, 3817363.7449174877
            // ]

        },
        "model": {
            "gltf": "cesium/Models/CesiumMilkTruck/CesiumMilkTruck.glb",
            "scale": 1.0,
            "minimumPixelSize": 58
        }
    }, {
        "id": "GroundVehicle_model2",
        "name": "Cesium GroundVehicle",
        "position": {
            "cartographicDegrees": [
                // "2018-07-19T15:18:00Z", -78.00, 37, 10,
                // "2018-07-19T15:18:40Z", -78.0040, 37, 10,
                // "2018-07-19T15:19:00Z", -78.00401, 37, 10
                "2018-07-19T15:18:00Z", -78.00146619105229, 36.999840361386354, 70,
                "2018-07-19T15:18:30Z", -78.00166324552615, 36.99974620069318, 70,
                "2018-07-19T15:18:40Z", -78.00185990589105, 36.99965222832139, 70,
                "2018-07-19T15:19:00Z", -78.0018603, 36.99965204, 70
            ]
            // "interpolationAlgorithm": "LINEAR",
            // "forwardExtrapolationType": "HOLD",
            // "cartesian": [
            //     "2018-07-19T15:18:00Z", 1060223.7482783734, -4988588.280207378, 3817382.622330465,
            //     "2018-07-19T15:18:40Z", 1060192.2168934273, -4988607.771653484, 3817366.019811927,
            //     "2018-07-19T15:19:00Z", 1060192.0488749647, -4988607.875620845, 3817365.9312060727
            // ]
        },
        "model": {
            "gltf": "cesium/Models/CesiumMilkTruck/CesiumMilkTruck.glb",
            "scale": 1.0,
            "minimumPixelSize": 58
        }
    }, {
        "id": "fragment1",
        "name": "fragment1",
        "position": {
            "cartographicDegrees": [
                "2018-07-19T15:18:40Z", -78.0018806382118, 36.999637951771874, 65.26599519221014,
                "2018-07-19T15:19:00Z", -78.0011793647109, 36.998640226966955, 100
            ]
        },
        "model": {
            "gltf": "cesium/Models/fire.gltf",
            "scale": 0.01,
            "minimumPixelSize": 30
        }
    }, {
        "id": "fragment2",
        "name": "fragment2",
        "position": {
            "cartographicDegrees": [
                "2018-07-19T15:18:40Z", -78.0018806382118, 36.999637951771874, 65.26599519221014,
                "2018-07-19T15:19:00Z", -78.00136721383657, 36.99947374755511, 100
            ]
        },
        "model": {
            "gltf": "cesium/Models/fire.gltf",
            "scale": 0.01,
            "minimumPixelSize": 30
        }
    }, {
        "id": "fragment3",
        "name": "fragment3",
        "position": {
            "cartographicDegrees": [
                "2018-07-19T15:18:40Z", -78.0018806382118, 36.999637951771874, 65.26599519221014,
                "2018-07-19T15:19:00Z", -78.0014856509232, 36.99920783028405, 100
            ]
        },
        "model": {
            "gltf": "cesium/Models/fire.gltf",
            "scale": 0.01,
            "minimumPixelSize": 30
        }
    }, {
        "id": "fragment4",
        "name": "fragment4",
        "position": {
            "cartographicDegrees": [
                "2018-07-19T15:18:40Z", -78.0018806382118, 36.999637951771874, 65.26599519221014,
                "2018-07-19T15:19:00Z", -78.00166689717855, 37.000097287111146, 100
            ]
        },
        "model": {
            "gltf": "cesium/Models/fire.gltf",
            "scale": 0.01,
            "minimumPixelSize": 30
        }
    }, {
        "id": "fragment5",
        "name": "fragment5",
        "position": {
            "cartographicDegrees": [
                "2018-07-19T15:18:40Z", -78.0018806382118, 36.999637951771874, 65.26599519221014,
                "2018-07-19T15:19:00Z", -78.00209598356211, 37.00017945993864, 100
            ]
        },
        "model": {
            "gltf": "cesium/Models/fire.gltf",
            "scale": 0.01,
            "minimumPixelSize": 30
        }
    }, {
        "id": "fragment6",
        "name": "fragment6",
        "position": {
            "cartographicDegrees": [
                "2018-07-19T15:18:40Z", -78.0018806382118, 36.999637951771874, 65.26599519221014,
                "2018-07-19T15:19:00Z", -78.00241545321231, 36.99982562842852, 100
            ]
        },
        "model": {
            "gltf": "cesium/Models/fire.gltf",
            "scale": 0.01,
            "minimumPixelSize": 30
        }
    }];
    var dyn_czml = [{
        "id": "document",
        "name": "CZML_Model",
        "version": "1.0",
        "clock": {
            "interval": "2019-03-05T15:00:00Z/",
            "currentTime": "2019-03-05T15:00:00Z",
            "multiplier": 1,
            "range": "LOOP_STOP",
            "step": "SYSTEM_CLOCK_MULTIPLIER"
        }
    }, {
        "id": "GroundVehicle_model3",
        "name": "Cesium GroundVehicle",
        "position": {
            "cartographicDegrees": [
                // "2018-07-19T15:18:00Z", -123.07428185240943,44.05051562147769,-0.016489265655995997,
                // "2018-07-19T15:18:40Z", -123.07357554718455,44.05051539625325,-0.06271049828585994,
            ]
        },
        "model": {
            "gltf": "cesium/Models/CesiumMilkTruck/CesiumMilkTruck.glb",
            "scale": 1.0,
            "minimumPixelSize": 128
        }
    }];

    function middlePoint(x1, y1, x2, y2, per) {
        var mx = x1 + (x2 - x1) * per;
        var my = y1 + (y2 - y1) * per;
        console.log("起点：" + x1 + "," + y1 + "   " + "终点：" + x2 + "," + y2 + "  per：" + per + "中点：" + mx + "," + my);
    }

    // middlePoint(-78.00242281641076, 36.999381296457656, -78.00190569, 36.99962837, 0.5);
    // middlePoint(-78.00146619105229, 36.999840361386354, -78.0018603, 36.99965204, 0.5);
    function startCollision(CZML) {
        var point = viewer.entities.add({
            point: {
                outlineColor: Cesium.Color.BLACK,
            },
            position: Cesium.Cartesian3.fromDegrees(-78.0018806382118, 36.999637951771874, 65.5599519221014),
            show: false
        });

        function computeModelMatrix(entity, time) {
            return entity.computeModelMatrix(time, new Cesium.Matrix4());
        }

        var emitterModelMatrix = new Cesium.Matrix4();
        var translation = new Cesium.Cartesian3();
        var rotation = new Cesium.Quaternion();
        var hpr = new Cesium.HeadingPitchRoll();
        var trs = new Cesium.TranslationRotationScale();

        function computeEmitterModelMatrix() {
            hpr = Cesium.HeadingPitchRoll.fromDegrees(0.0, 0.0, 0.0, hpr);
            trs.translation = Cesium.Cartesian3.fromElements(0.0, 0.0, 0.0, translation);
            trs.rotation = Cesium.Quaternion.fromHeadingPitchRoll(hpr, rotation);

            return Cesium.Matrix4.fromTranslationRotationScale(trs, emitterModelMatrix);
        }

        var particleSystem = scene.primitives.add(new Cesium.ParticleSystem({
            startColor: Cesium.Color.LIGHTSEAGREEN.withAlpha(0.7),
            endColor: Cesium.Color.LIGHTSEAGREEN.withAlpha(0.7),
            // endColor : Cesium.Color.WHITE.withAlpha(0.0),
            image: 'cesium/Models/smoke.png',
            startScale: 1.0,
            endScale: 10.0,
            minimumParticleLife: 10,
            maximumParticleLife: 10,
            minimumSpeed: 0,
            maximumSpeed: 0,
            imageSize: new Cesium.Cartesian2(50, 50),
            emissionRate: 0,
            bursts: [
                // these burst will occasionally sync to create a multicolored effect
                new Cesium.ParticleBurst({time: 40.0, minimum: 50, maximum: 50})
            ],
            lifetime: 59.0,

            emitter: new Cesium.CircleEmitter(5.0),

            emitterModelMatrix: computeEmitterModelMatrix()
            // modelMatrix:computeModelMatrix(entity, time),

        }));
        viewer.scene.preUpdate.addEventListener(function (scene, time) {
            particleSystem.modelMatrix = computeModelMatrix(point, time);

            // Account for any changes to the emitter model matrix.
            particleSystem.emitterModelMatrix = computeEmitterModelMatrix();

            // Spin the emitter if enabled.
        });
        dataSourcePromise = viewer.dataSources.add(Cesium.CzmlDataSource.load(CZML));
        dataSourcePromise.then(function (dataSource) {
            console.log("开始碰撞演示");
            var mo1 = dataSource.entities.getById('GroundVehicle_model1');
            var mo2 = dataSource.entities.getById('GroundVehicle_model2');
            console.log(mo1.id.toString());
            mo1.orientation = new Cesium.VelocityOrientationProperty(mo1.position);
            mo2.orientation = new Cesium.VelocityOrientationProperty(mo2.position);
            var positionProperty1 = mo1.position;
            console.log(positionProperty1);
            console.log(mo1.position);
            var positionProperty2 = mo2.position;
            if (scene.clampToHeightSupported) {
                clock.shouldAnimate = true;
                var objectsToExclude1 = [mo1];
                var objectsToExclude2 = [mo2];
                scene.postRender.addEventListener(function () {
                    var position1 = positionProperty1.getValue(clock.currentTime);
                    mo1.position = scene.clampToHeight(position1, objectsToExclude1);
                    var position2 = positionProperty2.getValue(clock.currentTime);
                    mo2.position = scene.clampToHeight(position2, objectsToExclude2);
                });
            } else {
                console.log('This browser does not support clampToHeight.');
            }
            console.log('贴地完成');
            viewer.camera.setView({
                destination: new Cesium.Cartesian3(1060203.863393312, -4988683.797757099, 3817420.3150414284),
                orientation: new Cesium.HeadingPitchRoll(4.2892217081808806, -0.4799070147502502, 6.279789177843313),
                endTransform: Cesium.Matrix4.IDENTITY
            });
        });
    }

    function startDynRoute(CZML) {
        console.log(CZML[1].position.cartographicDegrees);
        dataSourcePromise = viewer.dataSources.add(Cesium.CzmlDataSource.load(CZML));
        dataSourcePromise.then(function (dataSource) {
            console.log("开始动态路径演示");
            var mo3 = dataSource.entities.getById('GroundVehicle_model3');
            var positionProperty = mo3.position;
            viewer.trackedEntity = mo3;
            if (scene.clampToHeightSupported) {
                clock.shouldAnimate = true;
                var objectsToExclude = [mo3];
                scene.postRender.addEventListener(function () {
                    var position = positionProperty.getValue(clock.currentTime);
                    mo3.position = scene.clampToHeight(position, objectsToExclude);
                });
            } else {
                console.log('This browser does not support clampToHeight.');
            }
            mo3.orientation = new Cesium.VelocityOrientationProperty(mo3.position);
        });
    }

    var operation_type;
    var element_image = "cesium/images/left_foot.JPG";
    var mark_color = Cesium.Color.WHITE;
    var dataSourcePromise;

    var entity = viewer.entities.add({
        id: 'GroundVehicle',
        position: Cesium.Cartesian3.fromDegrees(-123.0744619, 44.0503706, 0),
        model: {
            uri: 'cesium/Models/mesh_final.gltf',
            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
        },
        scale: 1.0,
        minimumPixelSize: 100,
        show: false,
        colorBlendMode: Cesium.ColorBlendMode.MIX
    });
    var entity1 = viewer.entities.add({
        id: 'ferrari',
        position: Cesium.Cartesian3.fromDegrees(-123.0744619, 44.0503706, 0),
        model: {
            uri: 'cesium/Models/mesh_final.gltf',
            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
        },
        scale: 1.0,
        minimumPixelSize: 100,
        show: false
    });


    function timeFormat(date) {
        var y = date.getFullYear();
        var mon = date.getMonth() + 1;
        if (mon.toString().length == 1) {
            mon = "0" + mon;
        }
        ;
        var d = date.getDay();
        if (d.toString().length == 1) {
            d = "0" + d;
        }
        ;
        var h = date.getHours();
        if (h.toString().length == 1) {
            h = "0" + h;
        }
        ;
        var min = date.getMinutes();
        if (min.toString().length == 1) {
            min = "0" + min;
        }
        ;
        var s = date.getSeconds();
        if (s.toString().length == 1) {
            s = "0" + s;
        }
        ;
        var mytimes = y + "-" + mon + "-" + d + "T" + h + ":" + min + ":" + s + "Z";
        return mytimes;
    }

    var PolyLinePrimitive = (function () {
        function _(positions) {
            this.options = {
                polyline: {
                    show: true,
                    // positions : Cesium.Cartesian3.fromDegreesArray(positions),
                    positions: positions,
                    clampToGround: true,
                    material: Cesium.Color.RED,
                    width: 5
                }
            };
            this.positions = positions;
            this._init();
        }

        _.prototype._init = function () {
            var _self = this;
            var _update = function () {
                return _self.positions;
            };
            //实时更新polyline.positions
            this.options.polyline.positions = new Cesium.CallbackProperty(_update, false);
            viewer.entities.add(this.options);
        };
        return _;
    })();

    var handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);
    var positions = [];
    var poly = undefined;
    var a = 0;
    var b = 0;
    var time = "2018-07-19T15:18:00Z";
    var time;
    var endtime;
    //设置鼠标左键点击事件
    handler.setInputAction(function (movement) {
            var windowPosition = viewer.camera.getPickRay(movement.position);
            var cartesianCoordinates = viewer.scene.globe.pick(windowPosition, viewer.scene);
            var longitude;
            var latitude;
            var height;
            if (cartesianCoordinates != undefined) {
                var cartoCoordinates = viewer.scene.globe.ellipsoid.cartesianToCartographic(cartesianCoordinates);
                longitude = Cesium.Math.toDegrees(cartoCoordinates.longitude);
                latitude = Cesium.Math.toDegrees(cartoCoordinates.latitude);
                height = 0;
                var cartographic2 = Cesium.Cartographic.fromDegrees(longitude, latitude);
                var promise = Cesium.sampleTerrainMostDetailed(viewer.scene.terrainProvider, [cartographic2]);
                Cesium.when(promise, function (updatedPositions) {
                    if (updatedPositions.length > 0) {
                        height = updatedPositions[0].height;
                        console.log("经度" + longitude + "纬度" + latitude + '高度：:' + (updatedPositions[0].height ? updatedPositions[0].height : 0));
                    } else {
                        console.log('无法获取高程');
                    }
                    if (operation_type == "drawRoute") {
                        if (scene.mode !== Cesium.SceneMode.MORPHING) {
                            var pickedObject = scene.pick(movement.position);
                            if (scene.pickPositionSupported && Cesium.defined(pickedObject) && pickedObject.node) {
                                var cartesian = viewer.scene.pickPosition(movement.position);

                                console.log("点击到tiles");
                                if (Cesium.defined(cartesian)) {
                                    console.log("点击到tiles");
                                    var cartographic = Cesium.Cartographic.fromCartesian(cartesian);
                                    var lng = Cesium.Math.toDegrees(cartographic.longitude);
                                    var lat = Cesium.Math.toDegrees(cartographic.latitude);
                                    var height = cartographic.height;//模型高度
                                    mapPosition = {x: lng, y: lat, z: height}
                                }
                            }
                        } else {
                            console.log("不支持模型表面坐标获取");
                        }
                        var ellipsoid = viewer.scene.globe.ellipsoid;
                        var cartographic = Cesium.Cartographic.fromDegrees(longitude, latitude, height);
                        var cartesian3 = ellipsoid.cartographicToCartesian(cartographic);
                        if (positions.length == 0) {
                            positions.push(cartesian3.clone());
                        }
                        positions.push(cartesian3);
                    }
                    if (operation_type == "mark_elements") {
                        var e = viewer.entities.add({
                            position: Cesium.Cartesian3.fromDegrees(longitude, latitude, height),
                            billboard: {
                                image: element_image,
                                // heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
                                scale: 0.2,
                                color: mark_color
                            },
                        });
                    }
                    if (operation_type == "locate_model") {
                        operation_type = null;
                        var url = "Files/" + $("#models").val();
                        alert("标定模型位置 经度：" + longitude + ",维度：" + latitude + "，高程：" + height);
                        var name = $("#models").find("option:selected").text();
                        var x = viewer.entities.add({
                            position: Cesium.Cartesian3.fromDegrees(longitude, latitude, height),
                            model: {
                                uri: url,
                                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                            },
                            scale: 1.0,
                            minimumPixelSize: 100
                        });
                        $.get("/model_location", {
                            "longitude": longitude,
                            "latitude": latitude,
                            "height": height,
                            "scene_id": $("#scene_id").val(),
                            "model_name": name
                        }, function (data) {
                            console.log("更改模型：" + name + "位置");
                        })
                    }
                });
            }
            var date = new Date(2019, 2, 1, 15, b, a);
            time = timeFormat(date);
            endtime = time;
            dyn_czml[1].position.cartographicDegrees.push(time, longitude, latitude, height);
            if (a == 59) {
                a = 0;
                b += 1;
            } else {
                a += 2;
            }
        },
        Cesium.ScreenSpaceEventType.LEFT_CLICK
    )
    //设置鼠标移动事件
    handler.setInputAction(function (movement) {
        if (operation_type == "drawRoute") {
            var windowPosition = viewer.camera.getPickRay(movement.endPosition);
            var cartesian = viewer.scene.globe.pick(windowPosition, viewer.scene);
            // var cartesian = viewer.camera.pickEllipsoid(movement.endPosition,scene.globe.ellipsoid);
            if (cartesian != undefined) {
                var cartographic = scene.globe.ellipsoid.cartesianToCartographic(cartesian);
                var longitude = Cesium.Math.toDegrees(cartographic.longitude);
                var latitude = Cesium.Math.toDegrees(cartographic.latitude);
                var height = 0;
                var cartographic2 = Cesium.Cartographic.fromDegrees(longitude, latitude);
                var promise = Cesium.sampleTerrainMostDetailed(viewer.scene.terrainProvider, [cartographic2]);
                Cesium.when(promise, function (updatedPositions) {
                    var ellipsoid = viewer.scene.globe.ellipsoid;
                    var cartographic = Cesium.Cartographic.fromDegrees(longitude, latitude, height);
                    var cartesian3 = ellipsoid.cartographicToCartesian(cartographic);
                    if (positions.length >= 2) {
                        if (!Cesium.defined(poly)) {
                            poly = new PolyLinePrimitive(positions);
                            console.log("开始划线");
                        } else {
                            positions.pop();
                            // cartesian3.y += (1 + Math.random());
                            positions.push(cartesian3);
                        }
                    }
                });
            }
        }
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
    //设置鼠标右键点击事件
    handler.setInputAction(function (movement) {
        // if (operation_type == "drawRoute") {
        if (positions.length != 0) {
            positions.pop();
            dyn_czml[0].clock.interval = dyn_czml[0].clock.interval + endtime;
            console.log(dyn_czml[0].clock.interval);
            startDynRoute(dyn_czml);
            operation_type = null;
        }
        if (operation_type == "mark_elements") {
            operation_type = null;
        }
        if (operation_type == "locate_model") {
            operation_type = null;
        }
    }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);
    //设置鼠标左键双击事件
    handler.setInputAction(function (movement) {
        if (operation_type == "drawRoute") {
            positions.pop();
            positions = [];
            operation_type = null;
        }

    }, Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);


    Sandcastle.addToolbarButton('创建案件', function () {
        window
            .open(
                "create_case.html",
                "create_case",
                "height=700, width=1000, top=200, left=300,toolbar=no, menubar=no, scrollbars=no, resizable=no, location=no, status=no");

    }, 'CreateCase');

    Sandcastle.addToolbarButton('创建场景', function () {

    }, 'CreateScene');
    Sandcastle.addToolbarButton('自定义路线', function () {
        // viewer.entities.removeAll();
        // positions=[];
        show_tileset();
        alert("开始规划路线，左键点击经过点，右键结束");
        operation_type = "drawRoute";
        // viewer.zoomTo(tileset);
        viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(114.21952507076327, 30.358135859723472, 800),
            orientation: {
                heading: 0.0,
                pitch: Cesium.Math.toRadians(-90.0),
                roll: 0.0
            }
        });
    }, 'caseMenu');
    Sandcastle.addToolbarButton('碰撞演示', function () {
        viewer.entities.removeAll();
        startCollision(czml);
    }, 'caseMenu');
    Sandcastle.addToolbarButton('加载模型', function () {
        console.log("正在转换OBJ文件");
        $.get("/buttonClicked", {"value": "send to server"}, function (data) {
            alert(data);
            var test = viewer.entities.add({
                id: 'test',
                position: Cesium.Cartesian3.fromDegrees(-122.0744619, 43.0503706, 0),
                model: {
                    uri: 'cesium/Models/test.gltf',
                    heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                },
                scale: 1.0,
                minimumPixelSize: 100,
                show: true
            });
            viewer.trackedEntity = test;
        })
    }, 'caseMenu');
    // Sandcastle.addToolbarMenu([{
    //     text: '装甲车模型',
    //     onselect: function () {
    //         viewer.entities.getById("GroundVehicle").show = true;
    //         viewer.entities.getById("ferrari").show = false;
    //         viewer.trackedEntity = entity;
    //     }
    // }, {
    //     text: '跑车模型',
    //     onselect: function () {
    //         viewer.entities.getById("ferrari").show = true;
    //         viewer.entities.getById("GroundVehicle").show = false;
    //         viewer.trackedEntity = entity1;
    //     }
    // }], 'modelMenu');
    // Sandcastle.addToolbarMenu([{
    //     text: '原色',
    //     onselect: function () {
    //         entity.model.color = Cesium.Color.fromAlpha(Cesium.Color.WHITE, parseFloat(1));
    //         entity1.model.color = Cesium.Color.fromAlpha(Cesium.Color.WHITE, parseFloat(1));
    //     }
    // }, {
    //     text: '红色',
    //     onselect: function () {
    //         entity.model.color = Cesium.Color.fromAlpha(Cesium.Color.RED, parseFloat(1));
    //         entity1.model.color = Cesium.Color.fromAlpha(Cesium.Color.RED, parseFloat(1));
    //     }
    // }, {
    //     text: '蓝色',
    //     onselect: function () {
    //         entity.model.color = Cesium.Color.fromAlpha(Cesium.Color.BLUE, parseFloat(1));
    //         entity1.model.color = Cesium.Color.fromAlpha(Cesium.Color.BLUE, parseFloat(1));
    //     }
    // }, {
    //     text: '绿色',
    //     onselect: function () {
    //         entity.model.color = Cesium.Color.fromAlpha(Cesium.Color.GREEN, parseFloat(1));
    //         entity1.model.color = Cesium.Color.fromAlpha(Cesium.Color.GREEN, parseFloat(1));
    //     }
    // }], 'modelMenu');
    Sandcastle.addToolbarButton('上传动力学模型', function () {
        $("#files").trigger("click");

    }, 'KineticMenu');
    Sandcastle.addToolbarButton('标注模式', function () {
        operation_type = "mark_elements";

    }, 'markMenu');

    //菜单案件与场景选项逻辑
    var cases;
    var scenes;
    $.get("/get_cases", {"value": "get_cases"}, function (data) {
        cases = data;
        cases.forEach(function (json) {
            $("#case_id").append('<option value=' + json.case_id + ' >' + json.case_id + '</option>');
        });
    })


    function locate_model(path) {
        alert("点击鼠标左键选定模型位置，右键单击退出模型定位模式");
        operation_type = "locate_model";
    }

    function get_scenes(case_id) {
        console.log("案件id为：" + case_id);
        $.get("/get_scenes", {"value": case_id}, function (data) {
            scenes = data;
            scenes.forEach(function (json) {
                $("#scene_id").append('<option value=' + json.scene_id + ' >' + json.scene_id + '</option>');
            });
        })
    }

    function get_element_menu(element_type) {
        console.log("要素大类为：" + element_type);
        $("#elements").find("option").remove();
        $("#elements").append("<option value='volvo' hidden>选择绑定要素</option>");
        $.get("/get_elements", {"element_type": "scene_handprint","scene_id":$("#scene_id").val()}, function (data) {
            console.log(data.msg);
            console.log("wanc");
            data.forEach(function (json) {
                $("#elements").append('<option value=' + json.ID + ' > 系列id：' + json.SERIAL_NO + '</option>');
            });
        })
    }
    function get_sub_menu(top_name) {
        console.log("图标大类名为：" + top_name);
        $("#sub_icon_menu").find("option").remove();
        $("#sub_icon_menu").append("<option value='volvo' hidden>选择图标子类</option>");
        $("#icon_menu").find("option").remove();
        $("#icon_menu").append("<option value='volvo' hidden>选择图标图片</option>");
        $.get("/get_sub_menu", {"value": top_name}, function (data) {
            sub_menu = data;
            sub_menu.forEach(function (sub_name) {
                console.log(sub_name);
                $("#sub_icon_menu").append('<option value=' + sub_name + ' >' + sub_name + '</option>');
            });
        })
    }

    function get_icon_menu(sub_name) {
        $("#icon_menu").find("option").remove();
        $("#icon_menu").append("<option value='volvo' hidden>选择图标图片</option>");
        var top_name = document.getElementById("top_icon_menu").value;
        console.log("图标大类名为：" + top_name);
        $.get("/get_icon_menu", {"top_name": top_name, "sub_name": sub_name}, function (data) {
            icon_menu = data;
            icon_menu.forEach(function (icon_name) {
                console.log(icon_name);
                $("#icon_menu").append('<option value=' + icon_name + ' >' + icon_name + '</option>');
            });
        })
    }

    function get_icon_image(icon_name) {
        var top_name = document.getElementById("top_icon_menu").value;
        var sub_name = document.getElementById("sub_icon_menu").value;
        element_image = "cesium/icons/" + top_name + "/" + sub_name + "/" + icon_name;
    }

    function show_operations(scene_id) {
        document.getElementById("operations").style.display = "";
        $.get("/get_kinetic_models", {"value": scene_id}, function (data) {
            console.log("选择场景号：" + scene_id);
            console.log(data);
            // data.forEach(function (icon_name) {
            //     console.log(icon_name);
            //     $("#icon_menu").append('<option value=' + icon_name + ' >' + icon_name + '</option>');
            // });
        })
    }

    function show_tileset() {
        viewer.entities.removeAll();
        var tileset = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
            url: 'cesium/Models/Tileset.json',
            maximumScreenSpaceError: 2,
            maximumNumberOfLoadedTiles: 500,
        }));
        tileset.readyPromise.then(function (tileset) {
            var boundingSphere = tileset.boundingSphere;
            var cartographic = Cesium.Cartographic.fromCartesian(boundingSphere.center);
            var surface = Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, 0.0);
            var height = 80;
            var offset = Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, height);
            var translation = Cesium.Cartesian3.subtract(offset, surface, new Cesium.Cartesian3());
            tileset.modelMatrix = Cesium.Matrix4.fromTranslation(translation);
            console.log("加载中");
            // viewer.camera.viewBoundingSphere(tileset.boundingSphere, new Cesium.HeadingPitchRange(0, -0.5, 0));
            // viewer.camera.setView({
            //     destination: Cesium.Cartesian3.fromDegrees(104.998359, 30.235408, 800),
            //     orientation: {
            //         heading: 0.0,
            //         pitch: Cesium.Math.toRadians(-90.0),
            //         roll: 0.0
            //     }
            // });
        });


        viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(114.21952507076327, 30.358135859723472, 800),
            orientation: {
                heading: 0.0,
                pitch: Cesium.Math.toRadians(-90.0),
                roll: 0.0
            }
        });
    }
</script>
</body>
</html>
