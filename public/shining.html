<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Use correct character set. -->
    <meta charset="utf-8">
    <!-- Tell IE to use the latest, best version. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>Hello World!</title>
    <script src="cesium/Cesium.js"></script>
    <script src="cesium/Sandcastle-header.js"></script>
    <script src="cesium/import/js/jQuery/jquery-2.1.4.min.js"></script>
    <style>
        @import url(cesium/bucket.css);
        @import url(cesium/Widgets/widgets.css);

        html, body, #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body onload="get_dat_arr()">
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar"></div>
<script>
    var arr;

    function get_dat_arr() {
        $.get("/get_dat_arr", {}, function (data) {
            console.log("获得dat文件");
            console.log(data.arr);
            arr = data.arr;
        })
    }

    var xx = Sandcastle.addToolbarButton('房屋隐藏/显示', function () {
        var status = viewer.entities.getById("house").show;
        if (status) {
            viewer.entities.getById("house").show = false;
        } else {
            viewer.entities.getById("house").show = true;
        }
        status = viewer.entities.getById("house").show;
    }, 'toolbar');
    var xx = Sandcastle.addToolbarButton('粒子隐藏/显示', function () {
        var status = primitives.show;
        if (status) {
            primitives.show = false;
        } else {
            primitives.show = true;
        }
        status = primitives.show;
    }, 'toolbar');

    var clock = new Cesium.Clock({
        startTime: Cesium.JulianDate.fromIso8601('2017-07-11T12:00:00Z'),
        stopTime: Cesium.JulianDate.fromIso8601('2017-07-11T12:01:00Z'),
        currentTime: Cesium.JulianDate.fromIso8601('2017-07-11T12:00:00Z'),
        clockRange: Cesium.ClockRange.LOOP_STOP,
        clockStep: Cesium.ClockStep.SYSTEM_CLOCK_MULTIPLIER,
        multiplier: 1,
        shouldAnimate: true
    });
    var viewer = new Cesium.Viewer('cesiumContainer', {
        shouldAnimate: true,
        clockViewModel: new Cesium.ClockViewModel(clock),
        selectionIndicator: false,
    });
    viewer.scene.globe.enableLighting = true;
    viewer.scene.globe.depthTestAgainstTerrain = true;
    var scene = viewer.scene;
    // var instances_arr = [];
    // var primitives_arr = [];
    function get_dat_arr() {
        $.get("/get_dat_arr", {"num": 0}, function (data) {
            var id = 0;
            var lon = -114.0;
            var lat = 40;
            var height = 20;
            for (; height <= 2500; height += 100) {
                for (; lat < 40.052; lat += 0.001) {
                    for (; lon < -113.945; lon += 0.001) {
                        // if (data.arrs[30][id] != 0) {
                            viewer.entities.add({
                                id: id,
                                position: Cesium.Cartesian3.fromDegrees(lon, lat, height),
                                billboard: {
                                    image: "cesium/图片1.jpg",
                                    // heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                                    scale: 0.2,
                                    scaleByDistance: new Cesium.NearFarScalar(0.5e1, 1, 8.0e4, 0.00001),
                                    color: Cesium.Color.BLACK,
                                    show: true,
                                },
                            });
                        // } else {
                        //     viewer.entities.add({
                        //         id: id,
                        //         position: Cesium.Cartesian3.fromDegrees(lon, lat, height),
                        //         billboard: {
                        //             image: "cesium/图片1.jpg",
                        //             // heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                        //             scale: 0.2,
                        //             scaleByDistance: new Cesium.NearFarScalar(0.5e1, 1, 8.0e4, 0.00001),
                        //             color: Cesium.Color.BLACK,
                        //             show: false,
                        //         },
                        //     });
                        // }
                        id++;
                    }
                    lon = -114;
                }
                lat = 40;
            }
            console.log(id);
            var x = 0;
            timer = setInterval(function () {
                if(x<299){
                    console.log("加载帧"+x);
                    for (var i = 0; i < data.arrs[x].length; i++) {
                        if (data.arrs[x][i] != 0) {
                            viewer.entities.getById(i).show = true;
                        } else {
                            viewer.entities.getById(i).show = false;
                        }
                    }
                    x++;
                }
            }, 500);
            // timer = setInterval(function () {
            //     if (viewer.clockViewModel.shouldAnimate == true) {
            //         for (var i = 0; i < data.arr.length; i++) {
            //             if(viewer.entities.getById(i)!=undefined&&viewer.entities.getById(i)!=null) {
            //                 viewer.entities.getById(i).billboard.color = Cesium.Color.fromRandom({alpha: 1.0});
            //             }
            //         }
            //     }
            // }, 100);
            // var old_mul=clock.multiplier;
            // setInterval(function () {
            //     if (old_mul!=clock.multiplier) {
            //         window.clearInterval(timer);
            //         timer=setInterval(function () {
            //             if (viewer.clockViewModel.shouldAnimate == true) {
            //                 for (var i = 0; i < data.arr.length; i++) {
            //                     if(viewer.entities.getById(i)!=undefined&&viewer.entities.getById(i)!=null) {
            //                         viewer.entities.getById(i).billboard.color = Cesium.Color.fromRandom({alpha: 1.0});
            //                     }
            //                 }
            //             }
            //         }, 1000/clock.multiplier);
            //         console.log("每秒"+clock.multiplier+"次");
            //         old_mul=clock.multiplier;
            //     }
            // }, 100);
        })
    }

    var entity = viewer.entities.add({
        id: "house",
        position: Cesium.Cartesian3.fromDegrees(-114.0, 40.00, 0),
        model: {
            uri: "cesium/Models/house.gltf",
            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
        },
        scale: 0.2,
        show: false
    });
    // var handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);
    // var cou=101;
    // handler.setInputAction(function (movement) {
    //     $.get("/get_dat_arr", {"num":cou}, function (data) {
    //         var arr=data.arr;
    //         for (var i = 0; i < arr.length; i++) {
    //                         if(arr[i]!=0) {
    //                             viewer.entities.getById(i).show=true;
    //                         }else{
    //                             viewer.entities.getById(i).show=false;
    //                         }
    //                     }
    //         console.log("获得数组"+cou+" "+data.count+"个点");
    //     })
    //     cou++;
    // }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    //定期修改颜色
    // var num = 0;


    // var timer = setInterval(function () {
    //     if (viewer.clockViewModel.shouldAnimate == true) {
    //             for (var i = 0; i < arr.length; i++) {
    //                     viewer.entities.getById(i).billboard.color = Cesium.Color.fromRandom({alpha: 1.0 });
    //             }
    //             num++;
    //     }
    // }, 1000);


    // var old_mul=clock.multiplier;
    // setInterval(function () {
    // if (old_mul!=clock.multiplier) {
    //     window.clearInterval(timer);
    //     timer=setInterval(function () {
    //         if (viewer.clockViewModel.shouldAnimate == true) {
    //             for (var i = 0; i < data.arr.length; i++) {
    //                 if(viewer.entities.getById(i)!=undefined&&viewer.entities.getById(i)!=null) {
    //                     viewer.entities.getById(i).billboard.color = Cesium.Color.fromRandom({alpha: 1.0});
    //                 }
    //             }
    //         }
    //     }, 1000/clock.multiplier);
    //     console.log("每秒"+clock.multiplier+"次");
    //     old_mul=clock.multiplier;
    // }
    // }, 100);
    viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(-113.972, 40.026, 3000),
        orientation: {

            heading: 0.0,
            pitch: Cesium.Math.toRadians(-90.0),
            roll: 0.0
        }
    });
</script>
</body>
</html>
