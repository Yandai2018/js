<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Use correct character set. -->
    <meta charset="utf-8">
    <!-- Tell IE to use the latest, best version. -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>Hello World!</title>
    <script src="cesium/Cesium.js"></script>
    <script src="cesium/Sandcastle-header.js"></script>
    <style>
        @import url(cesium/bucket.css);

        #toolbar {
            background: rgba(42, 42, 42, 0.8);
            padding: 4px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar">
    <div id="caseMenu"></div>
    <div id="modelMenu"></div>
    <div id="DynRoute"></div>
</div>
<script>
    var viewer = new Cesium.Viewer('cesiumContainer', {
        shouldAnimate: true,
        homeButton: false,       //是否显示home键
        baseLayerPicker: false, //是否显示图层选择控件d
        timeline: false,        //是否显示时间线控件
        fullscreenButton: false, //是否全屏显示
        scene3DOnly: true,     //如果设置为true，则所有几何图形以3D模式绘制以节约GPU资源
        infoBox: true,         //是否显示点击要素之后显示的信息
        sceneModePicker: false,  //是否显示投影方式控件  三维/二维
        navigationInstructionsInitiallyVisible: false,
        navigationHelpButton: false,     //是否显示帮助信息控件
        selectionIndicator: false,        //是否显示指示器组件
        //terrainProvider : Cesium.createWorldTerrain(),   //加载地势
        // imageryProvider: new Cesium.createTileMapServiceImageryProvider({
        //     url: 'cesium/googleTMS',
        // })
    });
    viewer._cesiumWidget._creditContainer.style.display = "none";  //	去除版权信息
    var scene = viewer.scene;
    var clock = viewer.clock;

    var czml = [{
        "id": "document",
        "name": "CZML_Model",
        "version": "1.0",
        "clock": {
            "interval": "2018-07-19T15:18:00Z/2018-07-19T15:19:00Z",
            "currentTime": "2018-07-19T15:18:00Z",
            "multiplier": 5,
            "range": "LOOP_STOP",
            "step": "SYSTEM_CLOCK_MULTIPLIER"
        }
    }, {
        "id": "aircraft_model",
        "name": "Cesium Air",
        "position": {
            "cartographicDegrees": [
                "2018-07-19T15:18:00Z", 78.01, 37, 1000,
                "2018-07-19T15:19:00Z", 78.02, 37, 1000,
            ]
        },
        "model": {
            "gltf": "cesium/Models/CesiumAir/Cesium_Air.glb",
            "scale": 2.0,
            // "minimumPixelSize": 128
        },

    }, {
        "id": "man_model",
        "name": "Cesium Man",
        "position": {
            "cartographicDegrees": [-78, 38, 11]
        },
        "model": {
            "gltf": "cesium/Models/CesiumMan/Cesium_Man.glb",
            "scale": 20.0,
        },
    }, {
        "id": "GroundVehicle_model1",
        "name": "Cesium GroundVehicle",
        "position": {
            "cartographicDegrees": [
                // "2018-07-19T15:18:00Z", -78.01, 37, 10,
                // "2018-07-19T15:18:40Z", -78.0052, 37, 10,
                // "2018-07-19T15:19:00Z", -78.00519, 37, 10
                "2018-07-19T15:18:00Z", -78.00242281641076,36.999381296457656,-0.06436469597136314,
                "2018-07-19T15:18:40Z", -78.00190777893285,36.99962737273862,-0.016494937221925434,
                "2018-07-19T15:19:00Z", -78.00190569,36.99962837,-0.016465996558971567
            ]
        },
        "model": {
            "gltf": "cesium/Models/GroundVehicle/GroundVehicle.glb",
            "scale": 1.0,
            //"minimumPixelSize": 128
        },
    }, {
        "id": "GroundVehicle_model2",
        "name": "Cesium GroundVehicle",
        "position": {
            "cartographicDegrees": [
                // "2018-07-19T15:18:00Z", -78.00, 37, 10,
                // "2018-07-19T15:18:40Z", -78.0040, 37, 10,
                // "2018-07-19T15:19:00Z", -78.00401, 37, 10
                "2018-07-19T15:18:00Z", -78.00146619105229,36.999840361386354,-0.059932343767712046,
                "2018-07-19T15:18:40Z", -78.00185821083916,36.99965303971438,-0.016627335982995338,
                "2018-07-19T15:19:00Z", -78.0018603,36.99965204,-0.016566470135387236
            ]
        },
        "model": {
            "gltf": "cesium/Models/GroundVehicle/GroundVehicle.glb",
            "scale": 1.0,
            //"minimumPixelSize": 128
        },
    }, {
        "id": "Fire_Model",
        "name": "Cesium Fire_Model",
        "position": {
            "cartographicDegrees": [
            ]
        },
        "model": {
            "gltf": "cesium/Models/house.gltf",
            "scale": 0.10,
            //"minimumPixelSize": 28,
            "maxmumPixelSize": 200
        },
    }];
    var dyn_czml = [{
        "id": "document",
        "name": "CZML_Model",
        "version": "1.0",
        "clock": {
            "interval": "2019-03-05T15:00:00Z/",
            "currentTime": "2019-03-05T15:00:00Z",
            "multiplier": 1,
            "range": "LOOP_STOP",
            "step": "SYSTEM_CLOCK_MULTIPLIER"
        }
    }, {
        "id": "GroundVehicle_model3",
        "name": "Cesium GroundVehicle",
        "position": {
            "cartographicDegrees": [
                // "2018-07-19T15:18:00Z", -123.07428185240943,44.05051562147769,-0.016489265655995997,
                // "2018-07-19T15:18:40Z", -123.07357554718455,44.05051539625325,-0.06271049828585994,
            ]
        },
        "model": {
            "gltf": "cesium/Models/GroundVehicle/GroundVehicle.glb",
            "scale": 1.0,
            //"minimumPixelSize": 128
        }
    }];
    var drawRoute = false;
    var dataSourcePromise;
    function startCollision(CZML) {
        console.log(CZML[1].position.cartographicDegrees);
        dataSourcePromise = viewer.dataSources.add(Cesium.CzmlDataSource.load(CZML));
        dataSourcePromise.then(function (dataSource) {
            console.log("开始碰撞演示");
            var mo1 = dataSource.entities.getById('GroundVehicle_model1');
            var mo2 = dataSource.entities.getById('GroundVehicle_model2');
            console.log(mo1.id.toString());
            mo1.orientation = new Cesium.VelocityOrientationProperty(mo1.position);
            mo2.orientation = new Cesium.VelocityOrientationProperty(mo2.position);
            viewer.trackedEntity = mo2;
        });
    }
    function startDynRoute(CZML) {
        console.log(CZML[1].position.cartographicDegrees);
        dataSourcePromise = viewer.dataSources.add(Cesium.CzmlDataSource.load(CZML));
        dataSourcePromise.then(function (dataSource) {
            console.log("开始动态路径演示");
            var mo3 = dataSource.entities.getById('GroundVehicle_model3');
            mo3.orientation = new Cesium.VelocityOrientationProperty(mo3.position);
            viewer.trackedEntity = mo3;
        });
    }

    var entity = viewer.entities.add({
        id: 'GroundVehicle',
        position: Cesium.Cartesian3.fromDegrees(-123.0744619, 44.0503706, 0),
        model: {
            uri: 'cesium/Models/GroundVehicle/GroundVehicle.glb'
        },
        scale: 1.0,
        minimumPixelSize: 100,
        show: true,
        colorBlendMode: Cesium.ColorBlendMode.MIX
    });
    // if (scene.clampToHeightSupported) {
    //     console.log("转换贴地坐标");
    //     clock.shouldAnimate = true;
    //     var objectsToExclude = [entity];
    //     console.log("转换贴地坐标");
    //     scene.postRender.addEventListener(function() {
    //         var position = positionProperty.getValue(clock.currentTime);
    //         entity.position = scene.clampToHeight(position, objectsToExclude);
    //     });
    // } else {
    //     console.log('This browser does not support clampToHeight.');
    // }
    var entity1 = viewer.entities.add({
        id: 'ferrari',
        position: Cesium.Cartesian3.fromDegrees(-123.0744619, 44.0503706, 0),
        model: {uri: 'cesium/Models/ferrari.glb'},
        scale: 1.0,
        minimumPixelSize: 100,
        show: false
    });

    //设置菜单按钮功能
    //viewer.trackedEntity = entity;
    Sandcastle.addToolbarButton('自定义路线', function () {
        viewer.trackedEntity = null;
        viewer.entities.getById("GroundVehicle").show = true;
        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(-123.0744619, 44.0503706,100)     //相机飞入点
        });
        alert("开始规划路线，左键点击经过点，右键结束");
        drawRoute = true;
    }, 'caseMenu');
    Sandcastle.addToolbarButton('碰撞演示', function () {
        startCollision(czml);
    }, 'caseMenu');
    Sandcastle.addToolbarMenu([{
        text: '平面地球',
        onselect: function () {
            window.location.reload();
        }
    }, {
        text: '三维地球',
        onselect: function () {
            viewer.terrainProvider=Cesium.createWorldTerrain();
        }
    }], 'modelMenu');
    Sandcastle.addToolbarMenu([{
        text: '装甲车模型',
        onselect: function () {
            viewer.entities.getById("GroundVehicle").show = true;
            viewer.entities.getById("ferrari").show = false;
            viewer.trackedEntity = entity;
        }
    }, {
        text: '跑车模型',
        onselect: function () {
            viewer.entities.getById("ferrari").show = true;
            viewer.entities.getById("GroundVehicle").show = false;
            viewer.trackedEntity = entity1
        }
    }], 'modelMenu');
    Sandcastle.addToolbarMenu([{
        text: '原色',
        onselect: function () {
            entity.model.color = Cesium.Color.fromAlpha(Cesium.Color.WHITE, parseFloat(1));
            entity1.model.color = Cesium.Color.fromAlpha(Cesium.Color.WHITE, parseFloat(1));
        }
    }, {
        text: '红色',
        onselect: function () {
            entity.model.color = Cesium.Color.fromAlpha(Cesium.Color.RED, parseFloat(1));
            entity1.model.color = Cesium.Color.fromAlpha(Cesium.Color.RED, parseFloat(1));
        }
    }, {
        text: '蓝色',
        onselect: function () {
            entity.model.color = Cesium.Color.fromAlpha(Cesium.Color.BLUE, parseFloat(1));
            entity1.model.color = Cesium.Color.fromAlpha(Cesium.Color.BLUE, parseFloat(1));
        }
    }, {
        text: '绿色',
        onselect: function () {
            entity.model.color = Cesium.Color.fromAlpha(Cesium.Color.GREEN, parseFloat(1));
            entity1.model.color = Cesium.Color.fromAlpha(Cesium.Color.GREEN, parseFloat(1));
        }
    }], 'modelMenu');

    //设置鼠标命令
    // var fragmentShaderSource =
    //     'uniform sampler2D colorTexture;\n' +
    //     'varying vec2 v_textureCoordinates;\n' +
    //     'uniform vec4 highlight;\n' +
    //     'void main() {\n' +
    //     '    vec4 color = texture2D(colorTexture, v_textureCoordinates);\n' +
    //     '    if (czm_selected()) {\n' +
    //     '        vec3 highlighted = highlight.a * highlight.rgb + (1.0 - highlight.a) * color.rgb;\n' +
    //     '        gl_FragColor = vec4(highlighted, 1.0);\n' +
    //     '    } else { \n' +
    //     '        gl_FragColor = color;\n' +
    //     '    }\n' +
    //     '}\n';
    // var stage = scene.postProcessStages.add(new Cesium.PostProcessStage({
    //     fragmentShader: fragmentShaderSource,
    //     uniforms: {
    //         highlight: function () {
    //             return new Cesium.Color(1.0, 0.0, 0.0, 0.5);
    //         }
    //     }
    // }));
    // handler.setInputAction(function (movement) {
    //         //当鼠标移动时获取移动的末位置
    //         var pick = scene.pick(movement.endPosition);
    //         //简单来说就是这个点上有东西，那就打log
    //         if (Cesium.defined(pick) && Cesium.defined(pick.node) && Cesium.defined(pick.mesh)) {
    //             stage.selected = [pick.primitive];
    //             console.log('node: ' + pick.node.name + '. mesh: ' + pick.mesh.name);
    //         } else {
    //             stage.selected = [];
    //         }
    //     },
    //     Cesium.ScreenSpaceEventType.MOUSE_MOVE);

    function timeFormat(date) {
        var y = date.getFullYear();
        var mon = date.getMonth() + 1;
        if (mon.toString().length == 1) {
            mon = "0" + mon;
        }
        ;
        var d = date.getDay();
        if (d.toString().length == 1) {
            d = "0" + d;
        }
        ;
        var h = date.getHours();
        if (h.toString().length == 1) {
            h = "0" + h;
        }
        ;
        var min = date.getMinutes();
        if (min.toString().length == 1) {
            min = "0" + min;
        }
        ;
        var s = date.getSeconds();
        if (s.toString().length == 1) {
            s = "0" + s;
        }
        ;
        var mytimes = y + "-" + mon + "-" + d + "T" + h + ":" + min + ":" + s + "Z";
        return mytimes;
    }

    var handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);
    var PolyLinePrimitive = (function () {
        function _(positions) {
            this.options = {
                polyline: {
                    show: true,
                    positions: [],
                    material: Cesium.Color.CORNFLOWERBLUE,
                    width: 5
                }
            };
            this.positions = positions;
            this._init();
        }

        _.prototype._init = function () {
            var _self = this;
            var _update = function () {
                return _self.positions;
            };
            //实时更新polyline.positions
            this.options.polyline.positions = new Cesium.CallbackProperty(_update, false);
            viewer.entities.add(this.options);
        };

        return _;
    })();
    var handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);
    var positions = [];
    var poly = undefined;
    var a = 0;
    var b = 0;
    //var time="2018-07-19T15:18:00Z";
    var time;
    var endtime;
    handler.setInputAction(function (movement) {
        if (drawRoute == true) {
            var windowPosition = viewer.camera.getPickRay(movement.position);
            var cartesianCoordinates = viewer.scene.globe.pick(windowPosition, viewer.scene);
            var cartoCoordinates = viewer.scene.globe.ellipsoid.cartesianToCartographic(cartesianCoordinates);
            var longitude = Cesium.Math.toDegrees(cartoCoordinates.longitude);
            var latitude = Cesium.Math.toDegrees(cartoCoordinates.latitude);
            var height = Cesium.Math.toDegrees(cartoCoordinates.height);
            var date = new Date(2019, 2, 1, 15, b, a);
            time = timeFormat(date);
            endtime = time;
            console.log(time + "," + longitude + "," + latitude + "," + height);
            dyn_czml[1].position.cartographicDegrees.push(time, longitude, latitude, height);
            if (a == 59) {
                a = 0;
                b += 1;
            } else {
                a += 1;
            }
            var cartesian = scene.camera.pickEllipsoid(movement.position, scene.globe.ellipsoid);
            if (positions.length == 0) {
                positions.push(cartesian.clone());
            }
            positions.push(cartesian);
        }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    handler.setInputAction(function (movement) {
        if (drawRoute == true) {
            var cartesian = scene.camera.pickEllipsoid(movement.endPosition, scene.globe.ellipsoid);
            if (positions.length >= 2) {
                if (!Cesium.defined(poly)) {
                    poly = new PolyLinePrimitive(positions);
                } else {
                    positions.pop();
                    cartesian.y += (1 + Math.random());
                    positions.push(cartesian);
                }
            }
        }
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

    handler.setInputAction(function (movement) {
        if (drawRoute == true) {
            positions.pop();
            dyn_czml[0].clock.interval = dyn_czml[0].clock.interval + endtime;
            console.log(dyn_czml[0].clock.interval);
            startDynRoute(dyn_czml);
            handler.destroy();
            viewer.entities.getById("GroundVehicle").show = false;
        }
    }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);
    // viewer.camera.flyTo({
    //      destination : Cesium.Cartesian3.fromDegrees(-78, 37,6000.0)     //相机飞入点
    //  });
</script>
</body>
</html>
